{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import type { AuthConfig, CustomAuthHandler } from './types';\nimport type { RequestEvent } from '@sveltejs/kit';\nimport {\n\tauthKit as AuthKit,\n\tconfigureAuthKit as ConfigureAuthKit\n} from '@workos/authkit-sveltekit';\n\nimport { redirect, json } from '@sveltejs/kit';\nimport { ConvexHttpClient } from 'convex/browser';\nimport { setupConvex, useConvexClient, useQuery } from 'convex-svelte';\n\n// Globally scoped auth configuration\nlet authConfig: AuthConfig | undefined;\n\n/**\n * Authenticated request handler. Wraps a request handler with authentication.\n */\nfunction authenticatedRequest<T>(authKitInstance: typeof AuthKit, handler: CustomAuthHandler<T>) {\n\treturn authKitInstance.withAuth(async (event) => {\n\t\tdebug('authenticatedRequest', 'called');\n\t\tconst accessToken = event.auth.accessToken;\n\t\tconst user = event.auth.user;\n\n\t\tif (!user) {\n\t\t\tthrow redirect(302, 'api/auth/login');\n\t\t}\n\n\t\tif (!authConfig) {\n\t\t\tthrow new Error('Auth not configured. Please call configureAuth first.');\n\t\t}\n\n\t\t// Sync user data to Convex on login\n\t\tif (accessToken) {\n\t\t\tconst convexClient = new ConvexHttpClient(authConfig.convexUrl);\n\t\t\tconvexClient.setAuth(accessToken);\n\n\t\t\ttry {\n\t\t\t\tawait convexClient.mutation(authConfig.api.users.store, {\n\t\t\t\t\tworkosUserId: user.id,\n\t\t\t\t\temail: user.email,\n\t\t\t\t\tfirstName: user.firstName,\n\t\t\t\t\tlastName: user.lastName,\n\t\t\t\t\tprofilePictureUrl: user.profilePictureUrl\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error('Failed to sync user data:', error);\n\t\t\t}\n\t\t}\n\n\t\treturn handler(event);\n\t});\n}\n\n/**\n * Configure server authentication. Use this in hooks.server.ts\n */\nfunction configureServerAuth(\n\tconfig: AuthConfig,\n\tauthKitInstance: typeof AuthKit,\n\tconfigureAuthKit: typeof ConfigureAuthKit\n) {\n\tauthConfig = config;\n\n\tdebug('configureServerAuth', 'called');\n\tif (!authConfig) {\n\t\tthrow new Error('Auth configuration not found');\n\t}\n\tif (!authConfig.api) {\n\t\tthrow new Error('API not found');\n\t}\n\tif (!authConfig.api.users) {\n\t\tthrow new Error('Users API not found');\n\t}\n\n\tconfigureAuthKit({\n\t\tclientId: config.workos.clientId,\n\t\tapiKey: config.workos.apiKey,\n\t\tredirectUri: config.workos.redirectUri,\n\t\tcookiePassword: config.workos.cookiePassword\n\t});\n}\n\n/**\n * Configure client authentication. Use this in +layout.svelte\n */\nfunction configureClientAuth(browser: boolean, convexUrl: string) {\n\tdebug('configureClientAuth', `browser=${browser} convexUrl=${convexUrl}`);\n\tif (!convexUrl) {\n\t\tthrow new Error('ConvexUrl must be provided to client auth configuration.');\n\t}\n\n\tsetupConvex(convexUrl);\n\tdebug('configureClientAuth', `setupConvex ${convexUrl}`);\n\n\tif (browser) {\n\t\tdebug('configureClientAuth', 'setting up convex client');\n\t\tconst convex = useConvexClient();\n\t\tdebug('configureClientAuth', 'convex client initialized');\n\t\tconvex.setAuth(async () => {\n\t\t\ttry {\n\t\t\t\tdebug('configureClientAuth', 'fetching token');\n\t\t\t\tconst response = await fetch('/api/auth/token');\n\t\t\t\tdebug('configureClientAuth', `token response ok=${response.ok}`);\n\t\t\t\tif (!response.ok) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\tconst res = await response.json();\n\t\t\t\tdebug('configureClientAuth', 'token response parsed');\n\t\t\t\tif (!(res as { token: string }).token) {\n\t\t\t\t\tthrow new Error('Token not found');\n\t\t\t\t}\n\t\t\t\treturn (res as { token: string }).token;\n\t\t\t} catch (error) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t});\n\t}\n}\n\n/**\n * Token endpoint handler for /api/auth/token\n */\nfunction handleToken(authKitInstance: typeof AuthKit) {\n\tdebug('handleToken', 'called');\n\treturn authKitInstance.withAuth(async ({ auth }) => {\n\t\tdebug(\n\t\t\t'handleToken',\n\t\t\t`auth present user=${Boolean(auth.user)} token=${Boolean(auth.accessToken)}`\n\t\t);\n\t\tif (!auth.user || !auth.accessToken) {\n\t\t\treturn redirect(302, '/api/auth/login');\n\t\t}\n\t\tdebug('handleToken', 'returning token');\n\t\treturn json({ token: auth.accessToken });\n\t});\n}\n\n/**\n * Sign out handler for POST /api/auth/signout\n */\nfunction handleSignOut(authKitInstance: typeof AuthKit) {\n\tdebug('handleSignOut', 'called');\n\treturn authKitInstance.withAuth(async (event) => {\n\t\tdebug(\n\t\t\t'handleSignOut',\n\t\t\t`auth present user=${Boolean(event.auth.user)} token=${Boolean(event.auth.accessToken)}`\n\t\t);\n\t\tif (!event.auth.user || !event.auth.accessToken) {\n\t\t\treturn redirect(302, '/api/auth/login');\n\t\t}\n\t\tdebug('handleSignOut', 'signing out');\n\t\treturn authKitInstance.signOut(event as RequestEvent);\n\t});\n}\n\n/**\n * Sign in handler for GET /api/auth/signin\n * @param defaultReturnTo The default return to URL if no return to URL is provided in the query parameters. If neither is provided, the default return to URL is '/'.\n */\nfunction handleSignIn(authKitInstance: typeof AuthKit, defaultReturnTo: string = '/') {\n\tdebug('handleSignIn', `called defaultReturnTo=${defaultReturnTo}`);\n\tif (!authKitInstance) {\n\t\tthrow new Error('AuthKit instance not found');\n\t}\n\n\treturn async (event: RequestEvent) => {\n\t\tconst returnTo = (event.url.searchParams.get('return_to') as string) || defaultReturnTo;\n\t\tdebug('handleSignIn', `returnTo=${returnTo}`);\n\t\tconst signInUrl = await authKitInstance.getSignInUrl({\n\t\t\treturnTo: returnTo\n\t\t});\n\t\treturn redirect(302, signInUrl);\n\t};\n}\n\n/**\n * Debug function. Use this to log debug messages.\n * @param func The function name.\n * @param message The message to log.\n */\nfunction debug(func: string, message: string) {\n\tconsole.log(`[DEBUG] ${func}: ${message}`);\n}\n\nexport {\n\t// Server utilities\n\tconfigureServerAuth,\n\tauthenticatedRequest,\n\thandleToken,\n\thandleSignOut,\n\thandleSignIn,\n\t// Client utilities\n\tconfigureClientAuth\n};\n"]}