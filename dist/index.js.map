{"version":3,"sources":["../src/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import type { AuthConfig, CustomAuthHandler } from \"./types\";\nimport type { RequestEvent } from \"@sveltejs/kit\";\nimport {\n  authKit as AuthKit,\n  configureAuthKit as ConfigureAuthKit,\n} from \"@workos/authkit-sveltekit\";\n\nimport { redirect, json } from \"@sveltejs/kit\";\nimport { ConvexHttpClient } from \"convex/browser\";\nimport { setupConvex, useConvexClient, useQuery } from \"convex-svelte\";\n\n// Globally scoped auth configuration\nlet authConfig: AuthConfig | undefined;\n\n/**\n * Authenticated request handler. Wraps a request handler with authentication.\n */\nfunction authenticatedRequest<T>(authKitInstance: typeof AuthKit, handler: CustomAuthHandler<T>) {\n  return authKitInstance.withAuth(async (event) => {\n    debug('authenticatedRequest', 'called');\n    const accessToken = event.auth.accessToken;\n    const user = event.auth.user;\n\n    if (!user) {\n      throw redirect(302, \"api/auth/login\");\n    }\n\n    if (!authConfig) {\n      throw new Error(\"Auth not configured. Please call configureAuth first.\");\n    }\n\n    // Sync user data to Convex on login\n    if (accessToken) {\n      const convexClient = new ConvexHttpClient(authConfig.convexUrl);\n      convexClient.setAuth(accessToken);\n\n      try {\n        await convexClient.mutation(authConfig.api.users.store, {\n          workosUserId: user.id,\n          email: user.email,\n          firstName: user.firstName,\n          lastName: user.lastName,\n          profilePictureUrl: user.profilePictureUrl,\n        });\n      } catch (error) {\n        console.error(\"Failed to sync user data:\", error);\n      }\n    }\n\n    return handler(event);\n  });\n}\n\n/**\n * Configure server authentication. Use this in hooks.server.ts\n */\nfunction configureServerAuth(\n  config: AuthConfig,\n  authKitInstance: typeof AuthKit,\n  configureAuthKit: typeof ConfigureAuthKit,\n) {\n  authConfig = config;\n\n  debug('configureServerAuth', 'called');\n  if (!authConfig) {\n    throw new Error(\"Auth configuration not found\");\n  }\n  if (!authConfig.api) {\n    throw new Error(\"API not found\");\n  }\n  if (!authConfig.api.users) {\n    throw new Error(\"Users API not found\");\n  }\n\n  configureAuthKit({\n    clientId: config.workos.clientId,\n    apiKey: config.workos.apiKey,\n    redirectUri: config.workos.redirectUri,\n    cookiePassword: config.workos.cookiePassword,\n  });\n}\n\n/**\n * Configure client authentication. Use this in +layout.svelte\n */\nfunction configureClientAuth(browser: boolean, convexUrl: string) {\n  debug('configureClientAuth', `browser=${browser} convexUrl=${convexUrl}`);\n  if (!convexUrl) {\n    throw new Error(\"ConvexUrl must be provided to client auth configuration.\");\n  }\n\n  setupConvex(convexUrl);\n  debug('configureClientAuth', `setupConvex ${convexUrl}`);\n\n  if (browser) {\n    debug('configureClientAuth', 'setting up convex client');\n    const convex = useConvexClient();\n    debug('configureClientAuth', 'convex client initialized');\n    convex.setAuth(async () => {\n      try {\n        debug('configureClientAuth', 'fetching token');\n        const response = await fetch(\"/api/auth/token\");\n        debug('configureClientAuth', `token response ok=${response.ok}`);\n        if (!response.ok) {\n          return null;\n        }\n        const res = await response.json();\n        debug('configureClientAuth', 'token response parsed');\n        if (!(res as { token: string }).token) {\n          throw new Error(\"Token not found\");\n        }\n        return (res as { token: string }).token;\n      } catch (error) {\n        return null;\n      }\n    });\n  }\n}\n\n/**\n * Token endpoint handler for /api/auth/token\n */\nfunction handleToken(authKitInstance: typeof AuthKit) {\n  debug('handleToken', 'called');\n  return authKitInstance.withAuth(async ({ auth }) => {\n    debug('handleToken', `auth present user=${Boolean(auth.user)} token=${Boolean(auth.accessToken)}`);\n    if (!auth.user || !auth.accessToken) {\n      return redirect(302, \"/api/auth/login\");\n    }\n    debug('handleToken', 'returning token');\n    return json({ token: auth.accessToken });\n  });\n}\n\n/**\n * Sign out handler for POST /api/auth/signout\n */\nfunction handleSignOut(authKitInstance: typeof AuthKit) {\n  debug('handleSignOut', 'called');\n  return authKitInstance.withAuth(async (event) => {\n    debug('handleSignOut', `auth present user=${Boolean(event.auth.user)} token=${Boolean(event.auth.accessToken)}`);\n    if (!event.auth.user || !event.auth.accessToken) {\n      return redirect(302, \"/api/auth/login\");\n    }\n    debug('handleSignOut', 'signing out');\n    return authKitInstance.signOut(event as RequestEvent);\n  });\n}\n\n/**\n * Sign in handler for GET /api/auth/signin\n * @param defaultReturnTo The default return to URL if no return to URL is provided in the query parameters. If neither is provided, the default return to URL is '/'.\n */\nfunction handleSignIn(authKitInstance: typeof AuthKit, defaultReturnTo: string = '/') {\n  debug('handleSignIn', `called defaultReturnTo=${defaultReturnTo}`);\n  if(!authKitInstance) {\n    throw new Error(\"AuthKit instance not found\");\n  }\n\n  return async (event: RequestEvent) => {\n    const returnTo = (event.url.searchParams.get('return_to') as string) || defaultReturnTo;\n    debug('handleSignIn', `returnTo=${returnTo}`);\n    const signInUrl = await authKitInstance.getSignInUrl({\n      returnTo: returnTo\n    });\n    return redirect(302, signInUrl);\n  }\n}\n\n/**\n * Debug function. Use this to log debug messages.\n * @param func The function name.\n * @param message The message to log.\n */\nfunction debug(func: string, message: string) {\n  console.log(`[DEBUG] ${func}: ${message}`);\n}\n\nexport {\n  // Server utilities\n  configureServerAuth,\n  authenticatedRequest,\n  handleToken,\n  handleSignOut,\n  handleSignIn,\n  // Client utilities\n  configureClientAuth,\n  useConvexClient,\n  useQuery,\n};\n"]}